<lib-wait *ngIf="loading"></lib-wait>

<h1>{{transcript?transcript.id:id}}</h1>

<div *ngIf="transcript" id="transcript"
     [ngClass]="{'video-zoomed': videoZoomed}">

  <!-- previous/next transcript -->
  <nav>
    <div *ngIf="transcript.first('previous-transcript')"
         id="previous-transcript-link">
      <a rel="prev" href="transcript?id={{transcript.first('previous-transcript').label}}"
         i18n-title title="Previous">
        <img src="{{imagesLocation}}/previous.svg"
             i18n-alt alt="Previous"
             i18n-title title="Previous transcript in the episode">
      </a>
    </div>
    <div *ngIf="transcript.first('next-transcript')"
         id="next-transcript-link">
      <a rel="next" href="transcript?id={{transcript.first('next-transcript').label}}"
         i18n-title title="Next">
        <img src="{{imagesLocation}}/next.svg"
             i18n-alt alt="Next"
             i18n-title title="Next transcript in the episode">
      </a>
    </div>
  </nav>

  <!-- media -->
  <div *ngIf="media" id="media" class="media">
    <div *ngIf="media['video']" class="media-type video">
      <div *ngFor="let trackSuffix of media['video'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="video {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/video.svg" i18n-alt alt="video">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <video id="video-{{trackSuffix.value[0].nameWithoutSuffix}}"
                 preload="auto" 
                 title="{{trackSuffix.key}}"
                 controls
                 controlsList="{{!user.roles.includes('admin')&&!user.roles.includes('edit')?'nodownload':''}}"
                 (timeupdate)="mediaTimeUpdate($event);"
                 (play)="mediaPlay($event);"
                 (pause)="mediaPause($event);"
                 (error)="mediaError($event);"
                 >
            <source *ngFor="let file of trackSuffix.value"
                    src="{{file.url}}"
                    type="{{file.mimeType}}"/>
            <track *ngIf="mimeTypeToSerializer['text/vtt']"
                   kind="captions"
                   src="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType=text/vtt&layerId=word"
                   srclang="{{transcript.first('transcript_language').label||'en'}}"
                   i18n-label label="Transcript"
                   default/>
          </video>
        </div>
      </div>
    </div>
    <div *ngIf="media['audio']" class="media-type audio">
      <div *ngFor="let trackSuffix of media['audio'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="audio {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/audio.svg" i18n-alt alt="audio">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <audio id="audio-{{trackSuffix.value[0].nameWithoutSuffix}}"
                 preload="auto" 
                 title="{{trackSuffix.key}}"
                 controls
                 controlsList="{{!user.roles.includes('admin')&&!user.roles.includes('edit')?'nodownload':''}}"
                 (timeupdate)="mediaTimeUpdate($event);"
                 (play)="mediaPlay($event);"
                 (pause)="mediaPause($event);"
                 (error)="mediaError($event);"
                 >
            <source *ngFor="let file of trackSuffix.value"
                    src="{{file.url}}"
                    type="{{file.mimeType}}">
          </audio>
        </div>
      </div>
    </div>
    <div *ngIf="media['image']" class="media-type image">
      <div *ngFor="let trackSuffix of media['image'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="image {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/image.svg" i18n-alt alt="image">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <a href="{{trackSuffix.value[0].url}}"
             target="image"
             title="{{trackSuffix.value[0].name}}">
            <img src="{{trackSuffix.value[0].url}}" alt="{{trackSuffix.value[0].name}}">
          </a>
        </div>
      </div>
    </div>
    <div *ngIf="media['other']" class="media-type other">
      <div *ngFor="let trackSuffix of media['other'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="other {{trackSuffix.key}}">
        <div class="controls">
          <img class="icon" src="{{imagesLocation}}/other.svg" i18n-alt alt="other">
          <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
      </div>
    </div>    
    <div *ngIf="availableMedia.length == 0 && transcript.offsetUnits == 's'"
         id="local-media" >
      <!-- A local media file can be selected if there's no online media 
           and it's a temporal transcript -->
      <input *ngIf="!localMediaType"
             id="local-media-file"
             type="file"
             i18n-placeholder placeholder="Local media file"
             i18n-title title="Local media file"
             (click)="showMediaPrompt()"
             (change)="useLocalMedia($event)">
      <video *ngIf="localMediaType == 'video'"
             id="video-local"
             preload="auto" 
             i18n-title title="Local media"
             (timeupdate)="mediaTimeUpdate($event);"
             (play)="mediaPlay($event);"
             (pause)="mediaPause($event);"
             (error)="mediaError($event);"
             >
        <source src="{{localMediaUrl}}"/>
        <track *ngIf="mimeTypeToSerializer['text/vtt']"
               kind="captions"
               src="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType=text/vtt&layerId=word"
               srclang="{{transcript.first('transcript_language').label||'en'}}"
               i18n-label label="Transcript"
               default/>
      </video>
      <audio *ngIf="localMediaType == 'audio'"
             id="video-local"
             preload="auto" 
             i18n-title title="Local media"
             controls
             (timeupdate)="mediaTimeUpdate($event);"
             (play)="mediaPlay($event);"
             (pause)="mediaPause($event);"
             (error)="mediaError($event);"
             >
        <source src="{{localMediaUrl}}"/>
      </audio>
    </div>
    <div *ngIf="hasWAV || player" id="media-controls">
      <div *ngIf="hasWAV && praatIntegration" id="praat-integration">
        <progress id="praat-progress"
                  [max]="praatProgress.maximum"
                  [ngClass]="{error : praatProgress.error != null}"
                  [value]="praatProgress.value"
                  title="{{praatProgress.error}} {{praatProgress.message}} {{praatProgress.value?praatProgress.value*100/praatProgress.maximum:''}}%">
          {{praatProgress.error}} {{praatProgress.message}}
          {{praatProgress.value?praatProgress.value*100/praatProgress.maximum:""}}%
        </progress>
      </div>
      <lib-button *ngIf="hasWAV && praatIntegration == ''"
                  (press)="installPraatIntegration()"
                  img="praat.png" icon="ðŸ‘„"
                  i18n-title title="Set up Praat integration"
                  ></lib-button>        
      <lib-button *ngIf="visibleVideoCount"
                  (press)="videoZoomed = !videoZoomed"
                  [img]="(videoZoomed?'zoom-out':'zoom-in')+'.svg'" icon="ðŸ”"
                  i18n-title title="Large video"
                  ></lib-button>
      <lib-button *ngIf="player"
                  (press)="mediaRepeat();"
                  img="media-skip-backward.svg" icon="âª"
                  i18n-title title="Repeat"
                  ></lib-button>      
    </div>
  </div>

  <!-- layer selector, attributes etc. -->
  <div id="attributes" class="attribute-list tabs">
    <div class="tab-labels">
      <label *ngFor="let category of categoryLabels"
             [ngClass]="(category==currentCategory)?'tab-label active':'tab-label inactive'"
             (click)="currentCategory = currentCategory == category?null:category"
             title="{{categories[category].description}}">
        <img *ngIf="categories[category].icon"
             src="{{imagesLocation}}/{{categories[category].icon}}" alt="{{categories[category].description}}">
        {{category}}
      </label>
    </div>
    <div *ngFor="let category of categoryLabels"
         [ngClass]="(category==currentCategory)?'attribute-list tab-body active':'attribute-list tab-body inactive'">
      <!-- layers tab -->
      <div *ngIf="currentCategory == 'Layers'" class="layers">
        <lib-layer-checkboxes
          *ngIf="currentCategory == 'Layers'"
          [schema]="schema"
          name="layer" includeAlignment="true"
          span="true" phrase="true" word="true" segment="true"
          excludeMainParticipant="true" excludeTurn="true" excludeUtterance="true" excludeWord="true"
          category="true"
          [styles]="layerStyles"
          [interpretedRaw]="interpretedRaw"
          [selected]="selectedLayerIds"
          (selectedChange)="layersChanged($event)"></lib-layer-checkboxes>
        <div *ngIf="user && user.roles.includes('edit')" class="generate-layer">
          <div id="generateLayerSelection" *ngIf="showGenerateLayerSelection">
            <select [(ngModel)]="generateLayerId"
                    i18n-title title="Which layer to generate">
              <option value="" i18n>All layers</option>
              <ng-container *ngFor="let layer of generableLayers">
                <option value="{{layer.layer_id}}">{{layer.id}}</option>
              </ng-container>
            </select>
          </div>
          <lib-button
            (press)="generate()"
            img="cog.svg" icon="âš™"
            i18n-label label="Generate"
            i18n-title title="Regenerate layers for this transcript"
            ></lib-button>
        </div>
      </div>
      <!-- participants tab -->
      <div *ngIf="currentCategory == 'Participants'" class="participants">
        <ul>
          <li *ngFor="let participant of transcript.all('participant')"
              [ngClass]="{'participant':true, 'main-participant': participant.first('main_participant')}">
            <a href="{{baseUrl}}{{user && user.roles.includes('edit')?'edit/':''}}participant?id={{participant.label}}">
              {{participant.label}}
            </a>
          </li>
        </ul>
      </div>
      <!-- formats tab -->
      <div *ngIf="currentCategory == 'Formats'" class="formats">
        <ul>
          <li *ngFor="let serializer of serializers"
              i18n-title title="Convert to selected format">
            <a href="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType={{serializer.mimeType | urlEncode}}&layerId={{schema.wordLayerId | urlEncode}}{{selectedLayerIdParameters('layerId')}}"
               class="lnk">
              <img src="{{serializer.icon}}" alt="âš™">
              <span>{{serializer.name}}</span>
            </a>
          </li>
          <li *ngIf="originalFile" id="original-file-link">
            <a href="{{originalFile}}" class="lnk" download="{{transcript.id}}">
              <img src="{{imagesLocation}}/other.svg" alt="ðŸ—Ž">
              <span>{{transcript.id}}</span>
            </a>
          </li>
          <li id="episode-documents-link">
            <a href="{{baseUrl}}seriesFiles?family_id={{transcript.first('episode').id}}" class="lnk">
              <img src="{{imagesLocation}}/folder.svg" alt="ðŸ“" i18n>
              <span i18n>Documents for this episode</span>
            </a>
          </li>
        </ul>
      </div>
      <!-- attribute category tabs -->
      <div *ngFor="let layer of categoryLayers[category]" class="attribute">
        <label for="{{layer.id}}" title="{{layer.id}}{{layer.hint?': '+layer.hint:''}}">{{layer.description}}</label>
        <span *ngIf="transcript[layer.id]"
              id="{{layer.id}}" class="values">
          <div *ngFor="let annotation of transcript[layer.id]" class="value">
            <span class="label" title="{{annotation.annotator}} {{annotation.when | date:'medium'}}">{{annotation.label}}</span>
            <ng-container *ngIf="layer.type == 'boolean'">
              <span *ngIf="annotation.label == '1'" class="description">true</span>
              <span *ngIf="annotation.label == '0'" class="description">false</span>
            </ng-container>
            <ng-container *ngIf="layer.validLabels[annotation.label] && layer.validLabels[annotation.label] != annotation.label">
              <span class="description">{{layer.validLabels[annotation.label]}}</span>
            </ng-container>
          </div>
        </span>
      </div>
    </div>
  </div>

  <!-- transcript... -->
  <div id="temporal-blocks">
    <div *ngFor="let block of temporalBlocks"
         [ngClass]="{ 'block': true, 'consecutive': block.consecutive, 'simultaneous': !block.consecutive}">
      <div *ngFor="let utterance of block.utterances"
           id="{{utterance.id}}"
           [class.utterance]="true"
           [class.main-participant]="utterance.first('participant').first('main_participant')"
           [class.highlight]="utterance.id == highlitId"
           [class.playing]="player && !player.paused && playingId.includes(utterance.id)"
           [class.played]="previousPlayingId.includes(utterance.id)"
           title="{{utterance.label}}: {{utterance.start.offset}}-{{utterance.end.offset}} ({{utterance.duration()}}s)">
        <legend class="participant">{{utterance.label}}</legend>
        <a id="{{utterance.startId}}" class="anchor"></a>
        <lib-button *ngIf="praatUtterance == utterance"
                    class="import-changes"
                    (press)="praatImportChanges()"
                    img="save.svg" icon="âœ…"
                    i18n-label label="Import Changes"
                    i18n-title title="Import changes made to TextGrid into LaBB-CAT"
                    ></lib-button>        
        <div class="words">
          <span *ngFor="let word of utterance.all(schema.wordLayerId)"
                class="word" id="{{word.id}}">
            <a id="{{word.startId}}" class="anchor"></a>
            <span class="token">
              <!-- phrase/span layers -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isSpanningLayer(transcript.schema.layers[l])"
                      class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}} span"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}">
                  <ng-container *ngFor="let annotation of word.all(l)">
                    <span *ngIf="annotation"
                          [attr.id]="word == annotation.first('word')?annotation.id:(annotation.id+'-'+annotation.all('word').indexOf(word))"
                          [ngClass]="{ 'annotation' : true, 'first' : word == annotation.first('word'), 'during' : true, 'last' : word == annotation.last('word') && word.end.offset <= annotation.end.offset }"
                          title="{{l}}: {{annotation.label}}"
                          ><label
                             *ngIf="word == annotation.first('word') || word == utterance.first('word')"
                             [ngClass]="{'continued':word == utterance.first('word') && word != annotation.first('word')}">
                        <ng-container [ngSwitch]="annotation.layer.type">
                          <a *ngSwitchCase="'tree'"
                             class="tree" href="#{{annotation.id}}"
                             (click)="showTree(annotation);">{{renderLabel(annotation)}}</a>
                          <ng-container *ngSwitchDefault>{{renderLabel(annotation)}}</ng-container>
                        </ng-container>
                      </label>&nbsp;</span>
                    <span *ngIf="!annotation" class="annotation empty">&nbsp;</span>
                  </ng-container>
                </span>
              </ng-container>
              <!-- word layers -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isWordLayer(transcript.schema.layers[l])"
                      class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}}"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}: {{word.labels(l).join(' ')}}">
                  <span *ngFor="let annotation of word.all(l)"
                        id="{{annotation.id}}" class="annotation">{{renderLabel(annotation)}}&nbsp;</span>
                  <span *ngIf="word.all(l).length == 0"
                        class="annotation">&nbsp;</span>
                </span>
              </ng-container>
              <!-- word token -->
              <span class="layer layer-{{word.layerId}}"
                    [class.highlight]="word.id == highlitId"
                    (click)="menuId = menuId == word.id?null:word.id">
                <span id="{{word.id}}" class="annotation">{{renderLabel(word)}}&nbsp;</span>
              </span>
              <div *ngIf="menuId == word.id"
                   id="word-menu" class="menu">
                <div class="header" id="utterance-options">
                  <a class="permalink"
                     i18n-title title="Permalink to utterance"
                     href="{{baseUrl}}transcript?id={{transcript.id}}#{{utterance.id}}"
                     i18n>Utterance</a>
                </div>
                <ng-container *ngIf="hasWAV && praatIntegration">
                  <div class="item" id="praat-open">
                    <lib-menu-option        
                      (press)="praatUtteranceAudio(utterance); menuId = null;"
                      img="praat.png" icon="ðŸ‘„"
                      i18n-label label="Open in Praat"
                      i18n-title title="Open utterance audio in Praat"
                      ></lib-menu-option>
                  </div>
                  <div class="item" id="praat-open-textgrid">
                    <lib-menu-option        
                      (press)="praatUtteranceTextGrid(utterance); menuId = null;"
                      img="praat.png" icon="ðŸ‘„"
                      i18n-label label="Open TextGrid"
                      i18n-title title="Open utterance audio and TextGrid in Praat"
                      ></lib-menu-option>
                  </div>
                  <div class="item" id="praat-open-textgrid">
                    <lib-menu-option        
                      (press)="praatUtteranceContextTextGrid(utterance); menuId = null;"
                      img="praat.png" icon="ðŸ‘„"
                      i18n-label label="Open TextGrid Â± 1 utterance"
                      i18n-title title="Open utterance audio and TextGrid in Praat, including previous and next utterances"
                      ></lib-menu-option>
                  </div>
                </ng-container>
                <div *ngIf="hasWAV"
                     class="item" id="extract-audio-option">
                  <lib-menu-option        
                    (press)="utteranceAudio(utterance); menuId = null;"
                    img="audio.svg" icon="ðŸ”Š"
                    i18n-label label="Audio"
                    i18n-title title="Extract utterance audio fragment"
                    ></lib-menu-option>
                </div>
                <div *ngIf="visibleVideoCount + visibleAudioCount > 0"
                     class="item" id="play-utterance-option">
                  <lib-menu-option        
                    (press)="playSpan(utterance); menuId = null;"
                    img="play.svg" icon="â–¶"
                    i18n-label label="Play"
                    i18n-title title="Play this utterance"
                    ></lib-menu-option>
                </div>
                <div *ngIf="user.roles.includes('edit')"
                     class="item" id="edit-utterance-option">
                  <lib-menu-option        
                    (press)="editUtterance(utterance); menuId = null;"
                    img="edit.svg" icon="âœŽ"
                    i18n-label label="Edit Transcript"
                    i18n-title title="Edit utterance transcript"
                    ></lib-menu-option>
                </div>
                <div *ngIf="correctionEnabled"
                     class="item" id="suggest-correction-option">
                  <lib-menu-option        
                    (press)="suggestCorrection(utterance); menuId = null;"
                    img="edit.svg" icon="âœŽ"
                    i18n-label label="Suggest Correction"
                    i18n-title title="Suggest a correction to the transcription of this utterance"
                    ></lib-menu-option>
                </div>
                <div class="header" id="word-options">
                  <a class="permalink"
                     i18n-title title="Permalink to word"
                     href="{{baseUrl}}transcript?id={{transcript.id}}#{{word.id}}"
                     i18n>Word</a>
                </div>
                <div class="item" id="edit-word-option">
                  <lib-menu-option        
                    (press)="editWord(word); menuId = null;"
                    img="edit.svg" icon="âœŽ"
                    i18n-label label="Edit"
                    i18n-title title="Edit word token layers"
                    ></lib-menu-option>
                </div>
              </div>
              <!-- segment layers -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isSegmentLayer(transcript.schema.layers[l])"
                      class="layer layer-{{l}}"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}: {{word.labels(l).join(' ')}}">
                  <span *ngFor="let annotation of word.all(l)"
                        id="{{annotation.id}}" class="annotation">{{renderLabel(annotation)}}&nbsp;</span>
                  <span *ngIf="word.all(l).length == 0"
                        class="annotation">&nbsp;</span>
                </span>
              </ng-container>
            </span>
          </span>
        </div>
        <a *ngIf="utterance.last(transcript.schema.wordLayerId)"
           id="{{utterance.last(transcript.schema.wordLayerId).endId}}" class="anchor"></a>
      </div>
    </div>
  </div>
</div>
