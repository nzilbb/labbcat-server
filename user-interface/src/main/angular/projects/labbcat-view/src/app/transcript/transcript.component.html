<lib-wait *ngIf="loading"></lib-wait>

<h1 id="title">{{id}}</h1>

<div *ngIf="transcript" id="transcript"
     [ngClass]="{'video-zoomed': videoZoomed}"
     (click)="hideWordMenu();">

  <!-- previous/next transcript -->
  <nav>
    <div *ngIf="transcript.first('previous-transcript')"
         id="previous-transcript-link">
      <a rel="prev"
         href="transcript?transcript={{transcript.first('previous-transcript').label}}{{threadId?'&threadId='+threadId:''}}"
         accesskey="p"
         i18n-title title="Previous">
        <img src="{{imagesLocation}}/previous.svg"
             i18n-alt alt="Previous"
             i18n-title title="Previous transcript in the episode">
      </a>
    </div>
    <div *ngIf="transcript.first('next-transcript')"
         id="next-transcript-link">
      <a rel="next"
         href="transcript?transcript={{transcript.first('next-transcript').label}}{{threadId?'&threadId='+threadId:''}}"
         accesskey="n"
         i18n-title title="Next">
        <img src="{{imagesLocation}}/next.svg"
             i18n-alt alt="Next"
             i18n-title title="Next transcript in the episode">
      </a>
    </div>
  </nav>

  <!-- media -->
  <div *ngIf="media" id="media" class="media">
    <div *ngIf="media['video']" class="media-type video">
      <div *ngFor="let trackSuffix of media['video'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="video {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/video.svg" i18n-alt alt="video">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && user && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <video id="video-{{trackSuffix.value[0].nameWithoutSuffix}}"
                 preload="auto" 
                 title="{{trackSuffix.key}}"
                 controls
                 controlsList="{{user && !user.roles.includes('admin')&&!user.roles.includes('edit')?'nodownload':''}}"
                 (timeupdate)="mediaTimeUpdate($event);"
                 (play)="mediaPlay($event);"
                 (pause)="mediaPause($event);"
                 (error)="mediaError($event);"
                 >
            <source *ngFor="let file of trackSuffix.value"
                    src="{{file.url}}"
                    type="{{file.mimeType}}"/>
            <track *ngIf="mimeTypeToSerializer['text/vtt']"
                   kind="captions"
                   src="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType=text/vtt&layerId=word"
                   srclang="{{transcript.first('transcript_language').label||'en'}}"
                   i18n-label label="Transcript"
                   default/>
          </video>
        </div>
      </div>
    </div>
    <div *ngIf="media['audio']" class="media-type audio">
      <div *ngFor="let trackSuffix of media['audio'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="audio {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/audio.svg" i18n-alt alt="audio">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && user && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <audio id="audio-{{trackSuffix.value[0].nameWithoutSuffix}}"
                 preload="auto" 
                 title="{{trackSuffix.key}}"
                 controls
                 controlsList="{{user && !user.roles.includes('admin')&&!user.roles.includes('edit')?'nodownload':''}}"
                 (timeupdate)="mediaTimeUpdate($event);"
                 (play)="mediaPlay($event);"
                 (pause)="mediaPause($event);"
                 (error)="mediaError($event);"
                 >
            <source *ngFor="let file of trackSuffix.value"
                    src="{{file.url}}"
                    type="{{file.mimeType}}">
          </audio>
        </div>
      </div>
    </div>
    <div *ngIf="media['image']" class="media-type image">
      <div *ngFor="let trackSuffix of media['image'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="image {{trackSuffix.key}}">
        <div class="controls">
          <label>
            <input type="checkbox"
                   i18n-title title="Tick to show media"
                   [checked]="trackSuffix.value[0]._selected"
                   (change)="showMedia(trackSuffix.value[0])">
            <img class="icon" src="{{imagesLocation}}/image.svg" i18n-alt alt="image">
            <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          </label>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom && user && (user.roles.includes('admin') || !user.roles.includes('edit'))"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
        <div *ngIf="trackSuffix.value[0]._selected" class="visualization">
          <a href="{{trackSuffix.value[0].url}}"
             target="image"
             title="{{trackSuffix.value[0].name}}">
            <img src="{{trackSuffix.value[0].url}}" alt="{{trackSuffix.value[0].name}}">
          </a>
        </div>
      </div>
    </div>
    <div *ngIf="media['other']" class="media-type other">
      <div *ngFor="let trackSuffix of media['other'] | keyvalue"
           class="track {{trackSuffix.key}}"
           i18n-title title="other {{trackSuffix.key}}">
        <div class="controls">
          <img class="icon" src="{{imagesLocation}}/other.svg" i18n-alt alt="other">
          <span class="file-name">{{trackSuffix.value[0].nameWithoutSuffix}}</span>
          <span *ngFor="let file of trackSuffix.value"
                class="file-link {{file.extension}}">
            <a *ngIf="!file.generateFrom"
               href="{{file.url}}" download="{{file.name}}"
               i18n-title title="Download {{file.name}}">{{file.extension}}</a>
          </span>
        </div>
      </div>
    </div>    
    <div *ngIf="availableMedia.length == 0 && transcript.offsetUnits == 's'"
         id="local-media" >
      <!-- A local media file can be selected if there's no online media 
           and it's a temporal transcript -->
      <input *ngIf="!localMediaType"
             id="local-media-file"
             type="file"
             i18n-placeholder placeholder="Local media file"
             i18n-title title="Local media file"
             (click)="showMediaPrompt()"
             (change)="useLocalMedia($event)">
      <video *ngIf="localMediaType == 'video'"
             id="video-local"
             preload="auto" 
             i18n-title title="Local media"
             (timeupdate)="mediaTimeUpdate($event);"
             (play)="mediaPlay($event);"
             (pause)="mediaPause($event);"
             (error)="mediaError($event);"
             >
        <source src="{{localMediaUrl}}"/>
        <track *ngIf="mimeTypeToSerializer['text/vtt']"
               kind="captions"
               src="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType=text/vtt&layerId=word"
               srclang="{{transcript.first('transcript_language').label||'en'}}"
               i18n-label label="Transcript"
               default/>
      </video>
      <audio *ngIf="localMediaType == 'audio'"
             id="video-local"
             preload="auto" 
             i18n-title title="Local media"
             controls
             (timeupdate)="mediaTimeUpdate($event);"
             (play)="mediaPlay($event);"
             (pause)="mediaPause($event);"
             (error)="mediaError($event);"
             >
        <source src="{{localMediaUrl}}"/>
      </audio>
    </div>
    <div *ngIf="hasWAV || player" id="media-controls">
      <div *ngIf="hasWAV && praatIntegration" id="praat-integration">
        <label
          id="praat-message"
          title="{{praatProgress.error}} {{praatProgress.message}}"
          for="praat-progress">{{praatProgress.error}} {{praatProgress.message}}</label>
        <progress id="praat-progress"
                  [max]="praatProgress.maximum"
                  [ngClass]="{error : praatProgress.error != null}"
                  [value]="praatProgress.value">
          {{praatProgress.error}} {{praatProgress.message}}
          {{praatProgress.value?praatProgress.value*100/praatProgress.maximum:""}}%
        </progress>
      </div>
      <lib-button *ngIf="hasWAV && praatIntegration == ''"
                  (press)="installPraatIntegration()"
                  img="praat.png" icon="👄"
                  i18n-title title="Set up Praat integration"
                  ></lib-button>        
      <lib-button *ngIf="visibleVideoCount"
                  (press)="videoZoomed = !videoZoomed"
                  [img]="(videoZoomed?'zoom-out':'zoom-in')+'.svg'" icon="🔍"
                  i18n-title title="Large video"
                  ></lib-button>
      <lib-button *ngIf="player"
                  (press)="mediaRepeat();"
                  img="media-skip-backward.svg" icon="⏪"
                  i18n-title title="Repeat"
                  ></lib-button>      
      <lib-link *ngIf="user && user.roles.includes('edit')"
                class="buttons"
                i18n-title title="Edit Media"
                img="wrench.svg" icon="🔧"
                href="edit/transcript/media?id={{id | urlEncode}}"></lib-link>
    </div>
  </div>

  <!-- layer selector, attributes etc. -->
  <header id="attributes" class="attribute-list tabs">
    <div class="tab-labels" [class.video]="visibleVideoCount > 0">
      <label *ngFor="let category of categoryLabels"
             [ngClass]="(category==currentCategory)?'tab-label active':'tab-label inactive'"
             (click)="currentCategory = currentCategory == category?null:category"
             title="{{categories[category].description}}">
        <img *ngIf="categories[category].icon"
             src="{{imagesLocation}}/{{categories[category].icon}}" alt="{{categories[category].description}}">
        {{categories[category].label}}
      </label>
    </div>
    <div *ngFor="let category of categoryLabels"
         [ngClass]="(category==currentCategory)?'attribute-list tab-body active':'attribute-list tab-body inactive'">
      <!-- layers tab -->
      <div *ngIf="currentCategory == 'Layers'" id="layers">
        <lib-layer-checkboxes
          *ngIf="currentCategory == 'Layers'"
          [class.loading]="loading"
          [schema]="schema"
          name="layer" includeAlignment="true"
          span="true" phrase="true" word="true" segment="true"
          excludeMainParticipant="true" excludeTurn="true" excludeUtterance="true" excludeWord="true"
          category="true"
          [styles]="layerStyles"
          [interpretedRaw]="interpretedRaw"
          [selected]="selectedLayerIds"
          (selectedChange)="layersChanged($event)"></lib-layer-checkboxes>
        <div *ngIf="user && user.roles.includes('edit')" class="generate-layer">
          <div id="generateLayerSelection" *ngIf="showGenerateLayerSelection">
            <select [(ngModel)]="generateLayerId"
                    i18n-title title="Which layer to generate">
              <option value="" i18n>All layers</option>
              <ng-container *ngFor="let layer of generableLayers">
                <option value="{{layer.layer_id}}">{{layer.id}}</option>
              </ng-container>
            </select>
          </div>
          <lib-button
            (press)="generate()"
            img="cog.svg" icon="⚙"
            i18n-label label="Generate"
            i18n-title title="Regenerate layers for this transcript"
            ></lib-button>
        </div>
      </div>
      <!-- participants tab -->
      <div *ngIf="currentCategory == 'Participants'" id="participants">
        <ul>
          <li *ngFor="let participant of transcript.all('participant')"
              [ngClass]="{'participant':true, 'main-participant': participant.first('main_participant')}">
            <a href="{{baseUrl}}{{user && user.roles.includes('edit')?'edit/':''}}participant?id={{participant.label}}">
              {{participant.label}}
            </a>
          </li>
        </ul>
        <lib-link *ngIf="user && user.roles.includes('edit')"
                  class="buttons"
                  i18n-title title="Main Participants"
                  i18n-label label="Main Participants"
                  img="people.svg" icon="👥"
                  href="edit/transcript/mainParticipants?id={{id | urlEncode}}"></lib-link>
      </div>
      <!-- formats tab -->
      <div *ngIf="currentCategory == 'Formats'" id="formats">
        <ul>
          <li *ngFor="let serializer of serializers"
              i18n-title title="Convert to selected format">
            <a href="{{baseUrl}}api/serialize/graphs?id={{transcript.id}}&mimeType={{serializer.mimeType | urlEncode}}&layerId={{schema.wordLayerId | urlEncode}}&layerId={{schema.utteranceLayerId | urlEncode}}{{selectedLayerIdParameters('layerId')}}"
               class="lnk">
              <img src="{{serializer.icon}}" alt="⚙">
              <span>{{serializer.name}}</span>
            </a>
          </li>
          <li *ngIf="originalFile"
              id="original-file-link"
              i18n-title title="Original transcript file"
              [ngClass]="{'divergent': transcript.first('divergent')}"
              [attr.title]="transcript.first('divergent')?'The text of this transcript may have changed since the original file was uploaded':null"><!-- TODO i18n -->
            <a href="{{originalFile}}"
               class="lnk"
               (click)="divergentCheck();"
               download="{{transcript.id}}">
              <img src="{{imagesLocation}}/other.svg" alt="🗎">
              <span>{{transcript.id}}</span>
            </a>
          </li>
        </ul>
        <lib-link *ngIf="transcript.first('episode')"
                  id="episode-documents-link"
                  class="buttons"
                  href="{{baseUrl}}seriesFiles?family_id={{transcript.first('episode').id.replace('m_-50_','')}}"
                  img="folder.svg" icon="📁"
                  i18n-label label="Episode Documents"
                  i18n-title title="Documents for this episode"
                  ></lib-link>
      </div>
      <!-- attribute category tabs -->
      <div *ngFor="let layer of categoryLayers[category]" class="attribute">
        <label for="{{layer.id}}" title="{{layer.id}}{{layer.hint?': '+layer.hint:''}}">{{layer.description}}</label>
        <div *ngIf="transcript[layer.id]"
              id="{{layer.id}}" class="values">
          <div *ngFor="let annotation of transcript[layer.id]" class="value">
            <span class="label" title="{{annotation.annotator}} {{annotation.when | date:'medium'}}">{{annotation.label}}</span>
            <ng-container *ngIf="layer.type == 'boolean'">
              <span *ngIf="annotation.label == '1'" class="description">true</span>
              <span *ngIf="annotation.label == '0'" class="description">false</span>
            </ng-container>
            <ng-container *ngIf="layer.validLabels[annotation.label] && layer.validLabels[annotation.label] != annotation.label">
              <span class="description">{{layer.validLabels[annotation.label]}}</span>
            </ng-container>
          </div>
        </div>
      </div>
      <lib-link *ngIf="user && user.roles.includes('edit') && currentCategory == 'transcript_General'"
                class="buttons"
                href="{{baseUrl}}edit/transcript/attributes?id={{transcript.id}}"
                img="wrench.svg" icon="🔧"
                i18n-label label="Edit"
                i18n-title title="Edit transcript attributes"
                ></lib-link>
    </div>
  </header>

  <!-- transcript... -->
  <div id="temporal-blocks" [class.loading]="loading">
    <div *ngFor="let block of temporalBlocks"
         [ngClass]="{ 'block': true, 'consecutive': block.consecutive, 'simultaneous': !block.consecutive}">
      <div *ngFor="let utterance of block.utterances"
           id="{{utterance.id}}"
           [attr.turn-id]="utterance.parentId"
           [class.utterance]="true"
           [class.main-participant]="utterance.first('participant').first('main_participant')"
           [class.highlight]="utterance.id == highlitId"
           [class.playing]="player && !player.paused && playingId.includes(utterance.id)"
           [class.played]="previousPlayingId.includes(utterance.id)"
           title="{{utterance.label}}: {{utterance.start.offset | number:'1.1-4'}}-{{utterance.end.offset | number:'1.1-4'}} ({{utterance.duration() | number:'1.1-4'}}s)">
        <legend class="participant">{{utterance.label}}</legend>
        <a id="{{utterance.startId}}" class="anchor"></a>
        <lib-button *ngIf="praatUtterance == utterance && user && user.roles.includes('edit')"
                    class="import-changes"
                    (press)="praatImportChanges()"
                    img="save.svg" icon="✅"
                    i18n-label label="Import Changes"
                    i18n-title title="Import changes made to TextGrid into LaBB-CAT"
                    ></lib-button>        
          <!-- phrase/span layers starting and ending with this utterance  -->
          <ng-container *ngFor="let l of selectedLayerIds">
            <span *ngIf="isSpanningLayer(transcript.schema.layers[l]) && !isEmpty(transcript.schema.layers[l])"
                  class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}} span"
                  style="color: {{transcript.schema.layers[l].colour}};"
                  title="{{l}}">
              <ng-container *ngFor="let annotation of utterance[l]">
                <span [attr.id]="annotation.id"
                      [class.highlight]="annotation.id == highlitId"
                      [ngClass]="{ 'annotation' : true, 'first' : true, 'during' : true, 'last' : utterance.endId == annotation.endId, 'utterance-tag' : true }"
                      title="{{l}}: {{annotation.label}}"
                      ><label>
                    <ng-container [ngSwitch]="true">
                      <a *ngSwitchCase="annotation.layer.type == 'tree'"
                         class="tree" href="#{{annotation.id}}"
                         (click)="showTree(annotation);">{{renderLabel(annotation)}}</a>
                      <a *ngSwitchCase="annotation.layer.type.startsWith('image/')"
                         class="image" href="#{{annotation.id}}"
                         href="{{annotation.dataUrl}}&show"
                         target="{{annotation.id}}"
                         (mouseover)="annotation.preview = true;"
                         (mouseout)="annotation.preview = false;"
                         ><img *ngIf="!annotation.preview"
                               class="icon"
                               src="{{imagesLocation}}/image.svg"
                               alt="📷"
                               ><img *ngIf="annotation.preview"
                                     class="preview" src="{{annotation.dataUrl}}"
                                     alt="📷"></a>
                      <a *ngSwitchCase="annotation.layer.type.indexOf('/')>0 && !annotation.layer.type.startsWith('image/')"
                         class="blob" href="#{{annotation.id}}"
                         href="{{annotation.dataUrl}}"
                         target="{{annotation.id}}"
                         ><img class="icon"
                               src="{{imagesLocation}}/other.svg"
                               alt="🗎"
                               ></a>
                      <ng-container *ngSwitchDefault>{{renderLabel(annotation)}}</ng-container>
                    </ng-container>
                  </label>&nbsp;</span>
                <span *ngIf="!annotation" class="annotation empty">&nbsp;</span>
              </ng-container>
            </span>
          </ng-container>
        <div class="words">
          <span *ngIf="utterance.prependDummyToken" class="token dummy">
            <!-- phrase/span layers starting with this utterance and ending with the first word  -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isSpanningLayer(transcript.schema.layers[l]) && !isEmpty(transcript.schema.layers[l])"
                    class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}} span"
                    style="color: {{transcript.schema.layers[l].colour}};"
                    title="{{l}}">
                <ng-container *ngFor="let annotation of utterance.start.startOf[l]">
                  <span *ngIf="annotation && annotation.endId == utterance.first(schema.wordLayerId).startId"
                        [attr.id]="annotation.id"
                        [class.highlight]="annotation.id == highlitId"
                        [ngClass]="{ 'annotation' : true, 'first' : true, 'during' : true, 'last' : true }"
                        title="{{l}}: {{annotation.label}}"
                        ><label>
                      <ng-container [ngSwitch]="true">
                        <a *ngSwitchCase="annotation.layer.type == 'tree'"
                           class="tree" href="#{{annotation.id}}"
                           (click)="showTree(annotation);">{{renderLabel(annotation)}}</a>
                        <a *ngSwitchCase="annotation.layer.type.startsWith('image/')"
                           class="image" href="#{{annotation.id}}"
                           href="{{annotation.dataUrl}}&show"
                           target="{{annotation.id}}"
                           (mouseover)="annotation.preview = true;"
                           (mouseout)="annotation.preview = false;"
                           ><img *ngIf="!annotation.preview"
                                 class="icon"
                                 src="{{imagesLocation}}/image.svg"
                                 alt="📷"
                                 ><img *ngIf="annotation.preview"
                                       class="preview" src="{{annotation.dataUrl}}"
                                       alt="📷"></a>
                        <a *ngSwitchCase="annotation.layer.type.indexOf('/')>0 && !annotation.layer.type.startsWith('image/')"
                           class="blob" href="#{{annotation.id}}"
                           href="{{annotation.dataUrl}}"
                           target="{{annotation.id}}"
                           ><img class="icon"
                                 src="{{imagesLocation}}/other.svg"
                                 alt="🗎"
                                 ></a>
                        <ng-container *ngSwitchDefault>{{renderLabel(annotation)}}</ng-container>
                      </ng-container>
                    </label>&nbsp;</span>
                  <span *ngIf="!annotation" class="annotation empty">&nbsp;</span>
                </ng-container>
              </span>
            </ng-container>
            <!-- no word layer annotations without a word, but leave vertical space for them -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isWordLayer(transcript.schema.layers[l])"
                    class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}}">
                <span class="annotation">&nbsp;</span>
              </span>
            </ng-container>
            <!-- no word token, but leave a space for it -->
            <span class="layer"><span class="annotation">&nbsp;</span></span>
            <!-- segment layers -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isSegmentLayer(transcript.schema.layers[l])"
                    class="layer layer-{{l}} segment">
                <span class="annotation">&nbsp;</span>
              </span>
            </ng-container>
          </span><!-- phrases/spans starting with this utterance and ending with the first word -->
          <span *ngFor="let word of utterance.all(schema.wordLayerId)"
                class="word" id="{{word.id}}">
            <a id="{{word.startId}}" class="anchor"></a>
            <span class="token">
              <!-- phrase/span layers for this word -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isSpanningLayer(transcript.schema.layers[l]) && !isEmpty(transcript.schema.layers[l])"
                      class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}} span"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}">
                  <ng-container *ngFor="let annotation of word.all(l)">                    
                    <span *ngIf="annotation && !annotation.tagsUtterance"
                          [attr.id]="word == annotation.first('word')?annotation.id:(annotation.id+'-'+annotation.all('word').indexOf(word))"
                          [class.highlight]="annotation.id == highlitId"
                          [ngClass]="{ 'annotation' : true, 'first' : word == annotation.first('word'), 'during' : true, 'last' : word == annotation.last('word') && word.end.offset <= annotation.end.offset, 'jump' : annotation.jump }"
                          title="{{l}}: {{annotation.label}}"
                          ><label
                             *ngIf="word == annotation.first('word') || word == utterance.first('word')"
                             [ngClass]="{'continued':word == utterance.first('word') && word != annotation.first('word')}">
                        <ng-container [ngSwitch]="true">
                          <a *ngSwitchCase="annotation.layer.type == 'tree'"
                             class="tree" href="#{{annotation.id}}"
                             (click)="showTree(annotation);">{{renderLabel(annotation)}}</a>
                          <a *ngSwitchCase="annotation.layer.type.startsWith('image/')"
                             class="image" href="#{{annotation.id}}"
                             href="{{annotation.dataUrl}}&show"
                             target="{{annotation.id}}"
                             (mouseover)="annotation.preview = true;"
                             (mouseout)="annotation.preview = false;"
                             ><img *ngIf="!annotation.preview"
                                   class="icon"
                                   src="{{imagesLocation}}/image.svg"
                                   alt="📷"
                                   ><img *ngIf="annotation.preview"
                                         class="preview" src="{{annotation.dataUrl}}"
                                         alt="📷"></a>
                          <a *ngSwitchCase="annotation.layer.type.indexOf('/')>0 && !annotation.layer.type.startsWith('image/')"
                             class="blob" href="#{{annotation.id}}"
                             href="{{annotation.dataUrl}}"
                             target="{{annotation.id}}"
                             ><img class="icon"
                                   src="{{imagesLocation}}/other.svg"
                                   alt="🗎"
                                   ></a>
                          <ng-container *ngSwitchDefault>{{renderLabel(annotation)}}</ng-container>
                        </ng-container>
                      </label>&nbsp;</span>
                    <span *ngIf="!annotation" class="annotation empty">&nbsp;</span>
                  </ng-container>
                </span>
              </ng-container>
              <!-- word layers -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isWordLayer(transcript.schema.layers[l])"
                      class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}}"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}: {{word.labels(l).join(' ')}}">
                  <span *ngFor="let annotation of word.all(l)"
                        id="{{annotation.id}}"
                        [class.highlight]="annotation.id == highlitId"
                        class="annotation">{{renderLabel(annotation)}}&nbsp;</span>
                  <span *ngIf="word.all(l).length == 0"
                        class="annotation">&nbsp;</span>
                </span>
              </ng-container>
              <!-- word token -->
              <span class="layer layer-{{word.layerId}}"
                    [class.highlight]="word.id == highlitId"
                    [class.match]="word.id != highlitId && matchTokens[word.id]"
                    [class.menu-word]="menuId == word.id"
                    (click)="menuId = menuId == word.id?null:word.id; $event.stopPropagation();"
                    [attr.title]="matchTokens[word.id]?'Result '+matchTokens[word.id]:null">
                <span id="{{word.id}}" class="annotation">{{renderLabel(word)}}&nbsp;</span>
              </span>
              <div *ngIf="menuId == word.id"
                   id="word-menu" class="menu">
                <div class="header" id="utterance-options">
                  <a class="permalink"
                     i18n-title title="Permalink to utterance"
                     href="{{baseUrl}}transcript?transcript={{transcript.id}}#{{utterance.id}}"
                     i18n>Utterance</a>
                </div>
                <div *ngIf="visibleVideoCount + visibleAudioCount > 0"
                     class="item" id="play-utterance-option">
                  <lib-menu-option        
                    (press)="playSpan(utterance);"
                    img="play.svg" icon="▶"
                    i18n-label label="Play"
                    i18n-title title="Play this utterance"
                    ></lib-menu-option>
                </div>
                <div *ngIf="hasWAV"
                     class="item" id="extract-audio-option">
                  <lib-menu-option        
                    (press)="utteranceAudio(utterance); menuId = null;"
                    img="audio.svg" icon="🔊"
                    i18n-label label="Extract audio"
                    i18n-title title="Extract audio fragment for this utterance"
                    ></lib-menu-option>
                </div>
                <ng-container *ngIf="hasWAV && praatIntegration">
                  <div class="item" id="praat-open">
                    <lib-menu-option        
                      (press)="praatUtteranceAudio(utterance); menuId = null;"
                      img="praat.png" icon="👄"
                      i18n-label label="Open audio in Praat"
                      i18n-title title="Open utterance audio in Praat"
                      ></lib-menu-option>
                  </div>
                  <div class="item" id="praat-open-textgrid">
                    <lib-menu-option        
                      (press)="praatUtteranceTextGrid(utterance); menuId = null;"
                      img="praat.png" icon="👄"
                      i18n-label label="Open TextGrid in Praat"
                      i18n-title title="Open utterance audio and TextGrid in Praat"
                      ></lib-menu-option>
                  </div>
                  <div class="item" id="praat-open-textgrid">
                    <lib-menu-option        
                      (press)="praatUtteranceContextTextGrid(utterance); menuId = null;"
                      img="praat.png" icon="👄"
                      i18n-label label="Open TextGrid incl. ± 1 utterance in Praat"
                      i18n-title title="Open utterance audio and TextGrid in Praat, including previous and next utterances"
                      ></lib-menu-option>
                  </div>
                </ng-container>
                <div *ngIf="correctionEnabled"
                     class="item" id="suggest-correction-option">
                  <lib-menu-option        
                    (press)="suggestCorrection(utterance); menuId = null;"
                    img="edit.svg" icon="✎"
                    i18n-label label="Suggest correction"
                    i18n-title title="Suggest a correction to the transcription of this utterance"
                    ></lib-menu-option>
                </div>
                <div *ngIf="user && user.roles.includes('edit')"
                     class="item" id="edit-utterance-option">
                  <lib-menu-option        
                    (press)="editUtterance(utterance);"
                    img="edit.svg" icon="✎"
                    i18n-label label="Edit Transcript"
                    i18n-title title="Edit utterance transcript"
                    ></lib-menu-option>
                </div>
                <div class="header" id="word-options">
                  <a class="permalink"
                     i18n-title title="Permalink to word"
                     href="{{baseUrl}}transcript?transcript={{transcript.id}}#{{word.id}}"
                     i18n>Word</a>
                </div>
                <div *ngIf="user && user.roles.includes('edit')"
                     class="item" id="edit-word-option">
                  <lib-menu-option        
                    (press)="editWord(word);"
                    img="edit.svg" icon="✎"
                    i18n-label label="Edit"
                    i18n-title title="Edit word token layers"
                    ></lib-menu-option>
                </div>
              </div>
              <!-- segment layers -->
              <ng-container *ngFor="let l of selectedLayerIds">
                <span *ngIf="isSegmentLayer(transcript.schema.layers[l])"
                      class="layer layer-{{l}} segment"
                      style="color: {{transcript.schema.layers[l].colour}};"
                      title="{{l}}: {{word.labels(l).join(' ')}}">
                  <span *ngFor="let annotation of word.all(l)"
                        id="{{annotation.id}}"
                        [class.highlight]="annotation.id == highlitId"
                        class="annotation">{{renderLabel(annotation)}}
                    <ng-container *ngIf="annotation.layer.type != 'ipa'">&nbsp;</ng-container></span>
                  <span [class.annotation]="word.all(l).length == 0">&nbsp;</span>
                </span>
              </ng-container>
            </span>
          </span>
          <span *ngIf="utterance.appendDummyToken" class="token dummy">
            <!-- phrase/span layers starting with the last word and ending with this utterance  -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isSpanningLayer(transcript.schema.layers[l]) && !isEmpty(transcript.schema.layers[l])"
                    class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}} span"
                    style="color: {{transcript.schema.layers[l].colour}};"
                    title="{{l}}">
                <ng-container *ngFor="let annotation of utterance.end.endOf[l]">
                  <span *ngIf="annotation && annotation.startId == utterance.last(schema.wordLayerId).endId"
                        [attr.id]="annotation.id"
                        [class.highlight]="annotation.id == highlitId"
                        [ngClass]="{ 'annotation' : true, 'first' : true, 'during' : true, 'last' : true }"
                        title="{{l}}: {{annotation.label}}"
                        ><label>
                      <ng-container [ngSwitch]="true">
                        <a *ngSwitchCase="annotation.layer.type == 'tree'"
                           class="tree" href="#{{annotation.id}}"
                           (click)="showTree(annotation);">{{renderLabel(annotation)}}</a>
                        <a *ngSwitchCase="annotation.layer.type.startsWith('image/')"
                           class="image" href="#{{annotation.id}}"
                           href="{{annotation.dataUrl}}&show"
                           target="{{annotation.id}}"
                           (mouseover)="annotation.preview = true;"
                           (mouseout)="annotation.preview = false;"
                           ><img *ngIf="!annotation.preview"
                                 class="icon"
                                 src="{{imagesLocation}}/image.svg"
                                 alt="📷"
                                 ><img *ngIf="annotation.preview"
                                       class="preview" src="{{annotation.dataUrl}}"
                                       alt="📷"></a>
                        <a *ngSwitchCase="annotation.layer.type.indexOf('/')>0 && !annotation.layer.type.startsWith('image/')"
                           class="blob" href="#{{annotation.id}}"
                           href="{{annotation.dataUrl}}"
                           target="{{annotation.id}}"
                           ><img class="icon"
                                 src="{{imagesLocation}}/other.svg"
                                 alt="🗎"
                                 ></a>
                        <ng-container *ngSwitchDefault>{{renderLabel(annotation)}}</ng-container>
                      </ng-container>
                    </label>&nbsp;</span>
                  <span *ngIf="!annotation" class="annotation empty">&nbsp;</span>
                </ng-container>
              </span>
            </ng-container>
            <!-- no word layer annotations without a word, but leave vertical space for them -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isWordLayer(transcript.schema.layers[l])"
                    class="layer layer-{{l}} alignment-{{transcript.schema.layers[l].alignment}}">
                <span class="annotation">&nbsp;</span>
              </span>
            </ng-container>
            <!-- no word token, but leave a space for it -->
            <span class="layer"><span class="annotation">&nbsp;</span></span>
            <!-- segment layers -->
            <ng-container *ngFor="let l of selectedLayerIds">
              <span *ngIf="isSegmentLayer(transcript.schema.layers[l])"
                    class="layer layer-{{l}} segment">
                <span class="annotation">&nbsp;</span>
              </span>
            </ng-container>
          </span> <!-- phrases/spans starting with the last word and ending with this utterance -->
        </div>
        <a *ngIf="utterance.last(transcript.schema.wordLayerId)"
           id="{{utterance.last(transcript.schema.wordLayerId).endId}}" class="anchor"></a>
      </div>
    </div>
  </div>
</div>
